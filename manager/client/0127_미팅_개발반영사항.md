# 0127 미팅 내용 - 개발 반영 사항 정리

## 1. 날짜 속성(타입) 시스템 [신규 기능]

### 1.1 날짜 타입 관리
- **타입 종류**: 학기중, 방학, 특수상황 등
- **관리 방식**: 관리자가 날짜 범위(시작일~종료일)에 타입 지정
- **DB 설계 필요**:

```sql
-- 날짜 타입 정의 테이블
CREATE TABLE date_type_definitions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  branch_id UUID REFERENCES branches(id),  -- 지점별 설정
  name TEXT NOT NULL,  -- '학기중', '방학', '특수' 등
  default_start_time TIME NOT NULL,  -- 기본 의무 시작 시간
  default_end_time TIME NOT NULL,    -- 기본 의무 종료 시간
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 날짜별 타입 지정 테이블
CREATE TABLE date_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  branch_id UUID REFERENCES branches(id),
  date DATE NOT NULL,
  date_type_id UUID REFERENCES date_type_definitions(id),
  custom_start_time TIME,  -- 해당일 커스텀 시간 (null이면 기본값 사용)
  custom_end_time TIME,
  UNIQUE(branch_id, date)
);
```

### 1.2 의무 등원 시간 체크 로직
- 날짜 타입에 따른 **의무 시작/종료 시간** 자동 적용
- **버퍼 타임**: 의무 시간 앞뒤 1시간 범위까지 관리자 확인 가능
- **입출입 시간에 따른 알림/벌점 자동 부과**
  - 지각 시 → 알림 + 자동 벌점
  - 조기 퇴실 시 → 알림 + 자동 벌점

---

## 2. 하루 시간 기준 [핵심 설정]

### 2.1 시간 정의
| 항목 | 값 |
|------|-----|
| 하루 시작 | KST 07:30 |
| 하루 종료 | 다음날 KST 01:30 |
| 일주일 시작 | 일요일 |

### 2.2 개발 반영
- 모든 날짜/시간 계산 로직에서 위 기준 적용
- 새벽 1:30 이후 입실 → 다음 날짜로 계산
- UI에서 하루 타임라인 표시 시 07:30 ~ 01:30 범위로 표시

```typescript
// lib/constants.ts에 추가
export const DAY_CONFIG = {
  startHour: 7,
  startMinute: 30,
  endHour: 25,  // 다음날 01:30 = 25:30으로 계산
  endMinute: 30,
  weekStartsOn: 0,  // 일요일
} as const;
```

---

## 3. 학생 스케줄(부재 일정) 등록 [신규 기능]

### 3.1 기능 설명
- 학생이 **스터디카페에 없는 시간**을 캘린더 블록 형태로 등록
- **관리자, 학부모 모두 확인 가능**
- 현재 schedules 테이블 확장 또는 신규 테이블 필요

### 3.2 스케줄 유형
| 유형 | 설명 |
|------|------|
| 일회성 | 특정 날짜, 특정 시간 |
| 반복(주기적) | 매주 특정 요일, 특정 시간 |

### 3.3 DB 설계

```sql
-- 학생 부재 스케줄 테이블
CREATE TABLE student_absence_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID REFERENCES student_profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,  -- '학원', '과외' 등
  description TEXT,
  
  -- 반복 설정
  is_recurring BOOLEAN DEFAULT FALSE,
  recurrence_type TEXT CHECK (recurrence_type IN ('weekly', 'monthly', 'one_time')),
  day_of_week INTEGER[],  -- 0=일, 1=월, ..., 6=토 (배열로 복수 요일 지원)
  
  -- 시간 설정
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  
  -- 기간 설정 (반복 스케줄의 경우)
  date_type TEXT CHECK (date_type IN ('semester', 'vacation', 'all')),  -- 학기/방학/전체
  valid_from DATE,
  valid_until DATE,
  
  -- 일회성의 경우 특정 날짜
  specific_date DATE,
  
  -- 상태
  is_active BOOLEAN DEFAULT TRUE,  -- 온/오프 토글
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3.4 UI 요구사항
- 학생 앱: 캘린더 형태로 블록 추가/수정/삭제
- **입력 방식은 단순하게**: 요일 + 시간 위주
- 온/오프 토글로 활성화 제어
- 학부모/관리자: 읽기 전용으로 확인 가능

---

## 4. 출결 관리 고도화

### 4.1 중간 외출 처리 로직
| 상황 | 처리 |
|------|------|
| 외출 후 **15분 이내** 복귀 | 재실 상태 유지, 알림/벌점 없음 |
| 외출 후 **15분 초과** 복귀 | 퇴실 처리 → 재입실로 기록 |
| 10분 쉬는 시간 (짐 두고 나감) | **학부모에게는 퇴실로 표시** |

### 4.2 개발 반영
```typescript
// 출결 처리 로직
const GRACE_PERIOD_MINUTES = 15;

// 외출 시작 시간과 복귀 시간 비교
// 15분 초과 시 별도 퇴실/입실 기록 생성
// 15분 이내 시 외출 기록만 남기고 재실 상태 유지
```

### 4.3 학부모 뷰 특수 처리
- 학부모가 보는 학생 상태는 **물리적 존재 여부** 기준
- 짧은 외출도 "퇴실"로 표시
- 관리자/시스템 내부적으로는 "외출 중" 상태 별도 관리

---

## 5. 교시제 기능 [관리자 전용, 신규]

### 5.1 기능 설명
- 관리자가 시간표(교시) 설정 가능
- **학생 출입관리와는 별개** (순수 관리용)
- 타입별(학기/방학/특수)로 다른 시간표 지정 가능

### 5.2 DB 설계

```sql
-- 교시 정의 테이블
CREATE TABLE period_definitions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  branch_id UUID REFERENCES branches(id),
  date_type_id UUID REFERENCES date_type_definitions(id),
  period_number INTEGER NOT NULL,  -- 1교시, 2교시...
  name TEXT,  -- 선택적 이름
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(branch_id, date_type_id, period_number)
);
```

---

## 6. 주간 목표 시간 설정 [관리자 중앙 설정]

### 6.1 기능 설명
- **학년/타입별로 주간 학습 목표 시간** 중앙에서 설정
- 학생은 자기 타입에 맞는 목표 시간 자동 적용
- 순봉시간(순수 학습시간) 계산 및 달성도 표시

### 6.2 DB 설계

```sql
-- 학생 타입 정의
CREATE TABLE student_types (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,  -- '고3', '재수생', '고1 이하' 등
  weekly_goal_hours INTEGER NOT NULL,  -- 주간 목표 시간
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- student_profiles에 타입 연결
ALTER TABLE student_profiles ADD COLUMN student_type_id UUID REFERENCES student_types(id);
```

### 6.3 타입별 과목 설정
- 관리자가 **타입별로 선택 가능한 과목** 설정
- 학생은 자기 타입에 해당하는 과목만 선택 가능

---

## 7. 지점(브랜치) 관리 [신규]

### 7.1 기능 설명
- 압구정, 방구석, 잠실 등 **다중 지점 지원**
- 가입 시 지점 선택
- 지점별 필터링/정렬

### 7.2 DB 설계

```sql
CREATE TABLE branches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,  -- '압구정', '방구석', '잠실'
  address TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- profiles, student_profiles에 지점 연결
ALTER TABLE profiles ADD COLUMN branch_id UUID REFERENCES branches(id);
```

---

## 8. 알림 시스템 고도화

### 8.1 알림 채널 분리
| 대상 | 채널 | 비고 |
|------|------|------|
| 학부모 | 카카오톡 알림톡 | 실시간 |
| 학생 | 웹 브라우저 Push 알림 | 독서실 내 카카오톡 차단 |
| 학생 | 앱 내 알림 | 즉시 확인 가능 |

### 8.2 알림 목록 페이지
- 웹사이트에서 **전체 알림 목록** 확인 가능
- 읽음/안읽음 상태 관리

---

## 9. 회원가입 필드 추가

### 9.1 학생 추가 정보
- **생일** 필수 입력
- 추가 필드는 클라이언트에서 확정 후 반영

### 9.2 학부모-학생 연결
- 학생 코드로 매칭 (현재 구현됨)
- **승인 절차 없음** (코드 입력만으로 연결)

---

## 우선순위 정리

| 순위 | 기능 | 중요도 |
|------|------|--------|
| 1 | 하루 시간 기준 적용 (07:30~01:30) | 필수 |
| 2 | 날짜 타입 시스템 (학기/방학) | 필수 |
| 3 | 지점(브랜치) 관리 | 필수 |
| 4 | 학생 부재 스케줄 등록 | 필수 |
| 5 | 출결 관리 고도화 (15분 외출 로직) | 필수 |
| 6 | 주간 목표 시간 (타입별 중앙 설정) | 중요 |
| 7 | 교시제 기능 | 중요 |
| 8 | 학생 타입별 과목 설정 | 추가 |
| 9 | 알림 채널 분리 (카톡/웹푸시) | 추가 |

---

## 클라이언트로부터 전달받아야 할 정보 (액션 아이템)

- [ ] 출결 관련 벌점 및 알림 정책 구체화
- [ ] 지점 리스트
- [ ] 학생 정보 필수 입력 필드
- [ ] 학생 타입 리스트 (고3, 재수생, 고1 이하 등)
- [ ] 세부 정책 (외출 허용 시간 등)
